<!DOCTYPE html>
<html>
<head>
    <title>JobHelper projects running results</title>
    <link rel="icon" href="https://fav.farm/ðŸ“Š" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js"></script>
    <style>
    .mermaid {
      background-color: #ffffff;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
    <h1 class="mb-4 text-center">ðŸ“Š <span style="font-family: monospace;font-weight: bold;">JobHelper</span>  projects running results</h1>

    <div class="mb-4">
      <label for="project-id" class="form-label fw-semibold">Select Project:</label>
      <select id="project-id" name="project_id" class="form-select w-auto d-inline-block"></select>
      <label>
      <input type="checkbox" name="compact" id="compact-toggle" checked>
      Compact Mode
    </label>
    </div>

    <div class="row">
      <div class="col-md-12 mb-4">
        <div id="gantt-display"></div>
      </div>

      <div class="col-md-12">
        <div id="jobflow-display"></div>
      </div>
    </div>
  </div>

  <!-- Load chart + jobflow when selection changes -->
  <div
    hx-trigger="change from:#project-id"
    hx-get="/project_result/gantt"
hx-include="#project-id, #compact-toggle"
    hx-target="#gantt-display"
  ></div>
  <div
    hx-trigger="change from:#project-id"
    hx-get="/project_result/jobflow"
hx-include="#project-id, #compact-toggle"
    hx-target="#jobflow-display"
  ></div>
  <div
    hx-trigger="change from:#compact-toggle"
    hx-get="/project_result/gantt"
hx-include="#project-id, #compact-toggle"
    hx-target="#gantt-display"
  ></div>
  <div
    hx-trigger="change from:#compact-toggle"
    hx-get="/project_result/jobflow"
hx-include="#project-id, #compact-toggle"
    hx-target="#jobflow-display"
  ></div>


    <script>
    // Initialize Mermaid with specific settings
    document.addEventListener('DOMContentLoaded', function() {
      mermaid.initialize({ 
        startOnLoad: true,
        theme: 'default',
        securityLevel: 'loose',
        htmlLabels: true
      });
    });

    // Re-render Mermaid diagrams when new content is loaded
    document.addEventListener('htmx:afterSwap', function() {
      mermaid.init(undefined, '.mermaid');
    });
    </script>
</body>
</html>

<script>
// Fetch projects and populate dropdown on page load
document.addEventListener('DOMContentLoaded', function() {
  // Get the select element
  const selectElem = document.getElementById('project-id');

  // Fetch project list from API
  fetch('/project_result/')
    .then(response => response.json())
    .then(projects => {
      // Populate dropdown with projects
      for (const [id, projectData] of Object.entries(projects)) {
        const option = document.createElement('option');
        option.value = projectData;
        // option.textContent = projectData.title;
        option.textContent = projectData.toString();
        selectElem.appendChild(option);
      }

      // Trigger a change event to load the initial chart
      if (selectElem.options.length > 0) {
        const event = new Event('change');
        selectElem.dispatchEvent(event);
      }
    })
    .catch(error => {
      console.error('Error fetching projects:', error);
      document.getElementById('gantt-display').innerHTML = 
        '<p>Error loading projects. Please try again later.</p>';
    });
});
function copyTextToClipboard(text) {
  var textArea = document.createElement("textarea");
  textArea.value = text;
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    var successful = document.execCommand('copy');
    var msg = successful ? 'successful' : 'unsuccessful';
    alert('Job id (' + text + ') was copied.');
  } catch (err) {
    alert('Oops, unable to copy', err);
  }

  document.body.removeChild(textArea);
}
</script>
