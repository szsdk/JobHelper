<!DOCTYPE html>
<html>
  <head>
    <title>Project Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.31/vue.global.prod.min.js" integrity="sha512-Dg9zup8nHc50WBBvFpkEyU0H8QRVZTkiJa/U1a5Pdwf9XdbJj+hZjshorMtLKIg642bh/kb0+EvznGUwq9lQqQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js" integrity="sha512-JSCFHhKDilTRRXe9ak/FJ28dcpOJxzQaCd3Xg8MyF6XFjODhy/YMCM8HW0TFDckNHWUewW+kfvhin43hKtJxAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-mermaid-string@6.0.0/dist/index.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 60px 0 0 0; /* Add top padding */
  background-color: #f0f0f0;
}
#app {
  background-color: #fff;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h1 {
  color: #333;
  text-align: center; /* center the text */
}
.controls {
  display: flex;
  align-items: center;
  gap: 20px;
}
.controls > label {
  display: flex;
  align-items: center;
  gap: 10px;
}
.content {
  width: 95%;
  margin: auto;
}

.navbar {
  position: fixed;
  top: 0;
  width: 100%;
  height: 50px; /* Define a height for the navbar */
  z-index: 100;
  background-color: #f8f9fa; /* Light gray */
  padding: 10px 0; /* 10px top and bottom, 0 left and right */
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Slight shadow for depth */
  border-bottom: 1px solid #e7e7e7; /* Light border at the bottom */
}

@media (max-width: 600px) {
  body {
    font-size: 18px; /* Increase base font size */
  }
  .controls > label {
    font-size: 18px; /* Increase label font size */
  }
  .controls > label > select {
    height: 40px; /* Increase select box height */
    font-size: 18px; /* Increase select box font size */
  }
</style>
  </head>
  <body>
    <div id="app">
      <div class="navbar controls">
        <label>
          Project
          <select v-model="selectedProject" @change="selectProject">
            <option v-for="project in projects" :value="project">{{ project }}</option>
          </select>
        </label>
        <label>
          <input type="checkbox" v-model="compactMode">
          Compact Mode
        </label>
        <button @click="selectProject">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div class="content">
        <h1>Project running result</h1>
        <vue-mermaid-string :value="ganttStr" :options="{ securityLevel: 'loose' }" v-if="gantt"></vue-mermaid-string>
        <vue-mermaid-string :value="jobflowStr" :options="{ securityLevel: 'loose' }" v-if="jobflow"></vue-mermaid-string>
      </div>
    </div>

    <script>
    const { createApp, ref, onMounted, watch } = Vue;

    const app = createApp({
      components: {
        'vue-mermaid-string': VueMermaidString
      },
      data() {
        return {
          gantt: null,
          jobflow: null,
          projects: [],
          selectedProject: null,
          compactMode: true
        }
      },
      computed: {
        ganttStr() {
          if (this.gantt === null) {return null}
          return (this.compactMode ? `---
displayMode: compact
---
` : '') + this.gantt;
        },
        jobflowStr() {
          if (this.jobflow === null) {return null}
          let lines = this.jobflow.split('\n'); // split the string into lines
          lines[0] = 'flowchart LR'; // replace the first line
          return lines.join('\n'); // join the lines back into a string
        },
      },
      methods: {
        getGantt() {
          if (this.selectedProject) {
            axios.get(`/project_result/gantt/${this.selectedProject}`)
              .then(response => {
                this.gantt = response.data;
              })
              .catch(error => {
                console.log(error);
              });
          }
        },
        getJobflow() {
          if (this.selectedProject) {
            axios.get(`/project_result/jobflow/${this.selectedProject}`)
              .then(response => {
                this.jobflow =  response.data;
              })
              .catch(error => {
                console.log(error);
              });
          }
        },
        getSelectedProject(){
          this.getGantt();
          this.getJobflow();
        },
        selectProject() {
          this.getGantt();
          this.getJobflow();
        }
      },
      mounted() {
        axios.get('/project_result/')
          .then(response => {
            this.projects = response.data;
          })
          .catch(error => {
            console.log(error);
          });
    setInterval(() => {
      this.getGantt();
      this.getJobflow();
    }, 30000);  // 30000 milliseconds = 30 seconds
      },
      watch: {
        compactMode() {
          this.getGantt();
        }
      }
    });
    app.mount('#app');


    function copyTextToClipboard(text) {
      var textArea = document.createElement("textarea");
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        var successful = document.execCommand('copy');
        var msg = successful ? 'successful' : 'unsuccessful';
        alert('Job id (' + text + ') was copied.');
      } catch (err) {
        alert('Oops, unable to copy', err);
      }

      document.body.removeChild(textArea);
    }

    </script>
  </body>
</html>
